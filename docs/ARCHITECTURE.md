# Su-techs AI Chat - 技術スタックとアーキテクチャ

## システム全体図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Su-techs AI Chat 技術スタック                          │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              クライアント (ブラウザ)                           │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  React 19 + Next.js 16 (App Router)                                 │   │
│  │  ├─ Tailwind CSS 4 (スタイリング)                                    │   │
│  │  ├─ next-auth/react (認証フック)                                     │   │
│  │  └─ カスタムフック (useMessages, useStreamingMessage, useTheme)      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└───────────────────────────────────┬─────────────────────────────────────────┘
                                    │ HTTPS
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Google Cloud Run (コンテナ)                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                     Next.js 16 サーバー                              │   │
│  │  ┌───────────────────────────────────────────────────────────────┐  │   │
│  │  │  App Router                                                    │  │   │
│  │  │  ├─ /                    → ランディングページ (React SSR)       │  │   │
│  │  │  ├─ /chat                → チャット一覧 (React SSR)             │  │   │
│  │  │  ├─ /chat/[id]           → チャット画面 (React SSR)             │  │   │
│  │  │  ├─ /api/auth/*          → NextAuth.js (認証)                  │  │   │
│  │  │  └─ /api/*               → Hono API Router                     │  │   │
│  │  └───────────────────────────────────────────────────────────────┘  │   │
│  │                                                                      │   │
│  │  ┌───────────────────────────────────────────────────────────────┐  │   │
│  │  │  Hono (API フレームワーク)                                      │  │   │
│  │  │  ├─ GET  /api/chat           → チャット一覧取得                 │  │   │
│  │  │  ├─ POST /api/chat           → 新規チャット作成                 │  │   │
│  │  │  ├─ GET  /api/chat/:id       → チャット詳細取得                 │  │   │
│  │  │  ├─ DELETE /api/chat/:id     → チャット削除                     │  │   │
│  │  │  └─ POST /api/chat/:id/message/stream → AI応答 (SSE)           │  │   │
│  │  └───────────────────────────────────────────────────────────────┘  │   │
│  │                                                                      │   │
│  │  ┌───────────────────────────────────────────────────────────────┐  │   │
│  │  │  Mastra (AIエージェントフレームワーク)                          │  │   │
│  │  │  └─ chatAgent (Claude連携、ストリーミング対応)                  │  │   │
│  │  └───────────────────────────────────────────────────────────────┘  │   │
│  │                                                                      │   │
│  │  ┌───────────────────────────────────────────────────────────────┐  │   │
│  │  │  Prisma ORM (データベースアクセス)                              │  │   │
│  │  │  ├─ User      (ユーザー情報)                                   │  │   │
│  │  │  ├─ Account   (OAuth アカウント)                               │  │   │
│  │  │  ├─ Session   (セッション)                                     │  │   │
│  │  │  ├─ Chat      (チャット)                                       │  │   │
│  │  │  └─ Message   (メッセージ)                                     │  │   │
│  │  └───────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└──────────┬─────────────────────┬─────────────────────┬──────────────────────┘
           │                     │                     │
           ▼                     ▼                     ▼
┌──────────────────┐  ┌──────────────────┐  ┌──────────────────────┐
│  MongoDB Atlas   │  │   Google OAuth   │  │    Anthropic API     │
│  (データベース)   │  │   (認証)         │  │    (AI)              │
│                  │  │                  │  │                      │
│  ├─ users        │  │  ユーザー認証     │  │  Claude Sonnet 3.5   │
│  ├─ accounts     │  │  ├─ Client ID    │  │  ├─ チャット生成     │
│  ├─ sessions     │  │  └─ Client Secret│  │  └─ ストリーミング   │
│  ├─ chats        │  │                  │  │                      │
│  └─ messages     │  │                  │  │                      │
└──────────────────┘  └──────────────────┘  └──────────────────────┘
```

---

## 開発・デプロイ環境

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              開発・デプロイ環境                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ローカル開発                         CI/CD                                 │
│  ┌─────────────────────┐             ┌─────────────────────────────────┐   │
│  │  TypeScript 5.9     │             │  GitHub Actions                 │   │
│  │  ESLint 9 + Prettier│  git push   │  ├─ テスト (Vitest)             │   │
│  │  Vitest (単体テスト) │ ──────────► │  ├─ Docker ビルド               │   │
│  │  Playwright (E2E)   │             │  └─ Cloud Run デプロイ          │   │
│  └─────────────────────┘             └─────────────────────────────────┘   │
│                                                   │                         │
│                                                   ▼                         │
│                                      ┌─────────────────────────────────┐   │
│                                      │  Google Cloud Platform          │   │
│                                      │  ├─ Artifact Registry (Docker)  │   │
│                                      │  ├─ Cloud Run (コンテナ実行)     │   │
│                                      │  ├─ Secret Manager (秘密情報)    │   │
│                                      │  └─ Workload Identity (認証)    │   │
│                                      └─────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## データフロー (メッセージ送信時)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              データフロー (メッセージ送信時)                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ① ユーザーがメッセージ入力                                                  │
│       │                                                                     │
│       ▼                                                                     │
│  ② React → POST /api/chat/:id/message/stream                               │
│       │                                                                     │
│       ▼                                                                     │
│  ③ Hono → 認証チェック (NextAuth セッション確認)                             │
│       │                                                                     │
│       ▼                                                                     │
│  ④ Prisma → MongoDB にユーザーメッセージ保存                                 │
│       │                                                                     │
│       ▼                                                                     │
│  ⑤ Mastra chatAgent → Anthropic API (Claude) にリクエスト                   │
│       │                                                                     │
│       ▼                                                                     │
│  ⑥ Server-Sent Events (SSE) でストリーミングレスポンス                       │
│       │                                                                     │
│       ▼                                                                     │
│  ⑦ React → リアルタイムで画面に表示                                          │
│       │                                                                     │
│       ▼                                                                     │
│  ⑧ Prisma → MongoDB にAI応答を保存                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 技術スタック一覧

| レイヤー | 技術 | バージョン | 用途 |
|---------|------|-----------|------|
| **フロントエンド** | React | 19 | UIライブラリ |
| | Next.js | 16 | フルスタックフレームワーク |
| | Tailwind CSS | 4 | スタイリング |
| **バックエンド** | Hono | 4.11 | APIルーター |
| | NextAuth.js | 5 (beta) | 認証 |
| | Prisma | 5.22 | ORM |
| **AI** | Mastra | 0.24 | AIエージェント |
| | Anthropic SDK | 0.71 | Claude API |
| **データベース** | MongoDB Atlas | - | NoSQL DB |
| **インフラ** | Google Cloud Run | - | コンテナホスティング |
| | Docker | - | コンテナ化 |
| **CI/CD** | GitHub Actions | - | 自動デプロイ |
| **テスト** | Vitest | 4 | 単体テスト |
| | Playwright | 1.57 | E2Eテスト |

---

## ディレクトリ構成

```
ai-chat/
├── src/
│   ├── app/                      # Next.js App Router
│   │   ├── api/                  # API Routes
│   │   │   ├── auth/             # NextAuth.js
│   │   │   └── [[...route]]/     # Hono API
│   │   ├── chat/                 # チャットページ
│   │   │   ├── page.tsx          # 一覧
│   │   │   └── [id]/page.tsx     # 詳細
│   │   ├── layout.tsx            # ルートレイアウト
│   │   ├── page.tsx              # ランディングページ
│   │   └── globals.css           # グローバルスタイル
│   ├── components/               # React コンポーネント
│   │   ├── chat/                 # チャット関連
│   │   ├── layout/               # レイアウト
│   │   └── ui/                   # UIコンポーネント
│   ├── hooks/                    # カスタムフック
│   ├── lib/                      # ユーティリティ
│   │   ├── auth.ts               # NextAuth 設定
│   │   ├── prisma.ts             # Prisma クライアント
│   │   ├── api-client.ts         # API クライアント
│   │   └── mastra/               # Mastra 設定
│   ├── server/                   # サーバーサイド
│   │   └── api/                  # Hono API
│   └── test/                     # テストユーティリティ
├── prisma/
│   └── schema.prisma             # データベーススキーマ
├── public/                       # 静的ファイル
├── e2e/                          # E2E テスト
├── scripts/                      # デプロイスクリプト
├── docs/                         # ドキュメント
├── .github/workflows/            # GitHub Actions
├── Dockerfile                    # コンテナ定義
└── package.json                  # 依存関係
```

---

## 主要コンポーネントの関係

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            コンポーネント関係図                               │
└─────────────────────────────────────────────────────────────────────────────┘

フロントエンド (React)
━━━━━━━━━━━━━━━━━━━━━
                    ┌──────────────────┐
                    │    layout.tsx    │
                    │  (Providers)     │
                    └────────┬─────────┘
                             │
           ┌─────────────────┼─────────────────┐
           │                 │                 │
           ▼                 ▼                 ▼
    ┌────────────┐    ┌────────────┐    ┌────────────┐
    │  page.tsx  │    │ chat/page  │    │ chat/[id]  │
    │ (トップ)   │    │ (一覧)     │    │ (詳細)     │
    └────────────┘    └──────┬─────┘    └──────┬─────┘
                             │                 │
                    ┌────────┴─────────────────┤
                    │                          │
                    ▼                          ▼
             ┌────────────┐             ┌────────────┐
             │  Sidebar   │             │  ChatList  │
             └────────────┘             │  ChatInput │
                                        └────────────┘

バックエンド (Hono + Prisma + Mastra)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    ┌─────────────────────────────────────────────────┐
    │              Hono API Router                     │
    │  /api/chat, /api/chat/:id, /api/chat/:id/message│
    └───────────────────────┬─────────────────────────┘
                            │
              ┌─────────────┼─────────────┐
              │             │             │
              ▼             ▼             ▼
       ┌───────────┐ ┌───────────┐ ┌───────────┐
       │  Prisma   │ │  Mastra   │ │ NextAuth  │
       │  (CRUD)   │ │ (AI生成)  │ │  (認証)   │
       └─────┬─────┘ └─────┬─────┘ └─────┬─────┘
             │             │             │
             ▼             ▼             ▼
       ┌───────────┐ ┌───────────┐ ┌───────────┐
       │  MongoDB  │ │ Anthropic │ │  Google   │
       │  Atlas    │ │   API     │ │  OAuth    │
       └───────────┘ └───────────┘ └───────────┘
```

---

## 環境変数

| 変数名 | 説明 | 例 |
|--------|------|-----|
| `DATABASE_URL` | MongoDB 接続文字列 | `mongodb+srv://...` |
| `NEXTAUTH_SECRET` | NextAuth 暗号化キー | ランダム文字列 |
| `NEXTAUTH_URL` | アプリケーション URL | `https://xxx.run.app` |
| `GOOGLE_CLIENT_ID` | Google OAuth ID | `xxx.apps.googleusercontent.com` |
| `GOOGLE_CLIENT_SECRET` | Google OAuth Secret | `GOCSPX-xxx` |
| `ANTHROPIC_API_KEY` | Anthropic API キー | `sk-ant-xxx` |
| `AUTH_TRUST_HOST` | ホスト信頼設定 | `true` |
